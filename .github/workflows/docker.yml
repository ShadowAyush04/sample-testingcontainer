name: Build Docker Image

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- üèôÔ∏è ANTIGRAVITY OPTIMIZATION GATE START ---
      - name: Antigravity Optimization Gate
        env:
          USE_OPTIMIZED: 'true' 
          # üü¢ IMPORTANT: Paste your localtunnel URL here (e.g., https://xyz.loca.lt/api)
          OPTIMIZER_SERVER: 'PASTE_YOUR_TUNNEL_URL_HERE/api'
        run: |
          # 1. Download the tool (Verified URL for 'main' branch)
          curl -sSL https://raw.githubusercontent.com/codeayush004/techdemoversion1/main/container-optimizer/bin/optimizer-cli.py -o optimizer-cli.py
          
          # 2. Run the logic
          if [ "$USE_OPTIMIZED" = "true" ]; then
            echo "‚úÖ Permission Granted: Swapping with Optimized Dockerfile"
            python3 optimizer-cli.py --file Dockerfile --server "$OPTIMIZER_SERVER" --apply
          else
            echo "üê¢ Using Original Dockerfile (Scanning for Criticals only)"
            python3 optimizer-cli.py --file Dockerfile --server "$OPTIMIZER_SERVER" --fail-on CRITICAL
          fi
      # --- üèôÔ∏è ANTIGRAVITY OPTIMIZATION GATE END ---

      - name: Build Docker image
        run: |
          docker build -t bad-docker-app .