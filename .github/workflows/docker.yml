name: Build Docker Image

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- üèôÔ∏è ANTIGRAVITY OPTIMIZATION GATE START ---
      - name: Antigravity Optimization Gate
        env:
          USE_OPTIMIZED: 'true' 
          # üü¢ Your active Cloudflare Tunnel
          OPTIMIZER_SERVER: 'https://reasons-mats-consumption-putting.trycloudflare.com/api'
        run: |
          # 1. Download the tool from the main repo
          curl -sSL https://raw.githubusercontent.com/codeayush004/techdemoversion1/main/container-optimizer/bin/optimizer-cli.py -o optimizer-cli.py
          
          # 2. Optimization Logic
          if [ "$USE_OPTIMIZED" = "true" ]; then
            echo "‚úÖ Permission Granted: Swapping with Optimized Dockerfile"
            python3 optimizer-cli.py --file Dockerfile --server "$OPTIMIZER_SERVER" --apply
          else
            echo "üê¢ Using Original Dockerfile (Scanning for Criticals only)"
            python3 optimizer-cli.py --file Dockerfile --server "$OPTIMIZER_SERVER" --fail-on CRITICAL
          fi
      # --- üèôÔ∏è ANTIGRAVITY OPTIMIZATION GATE END ---

      - name: Build Docker image
        run: |
          # This builds the AI-fixed version if USE_OPTIMIZED was true
          docker build . -t bad-docker-app